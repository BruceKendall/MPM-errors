---
title: Persistent problems in the construction of matrix population models
author:
  - name: Bruce E. Kendall
    email: kendall@bren.ucsb.edu
    affiliation: UCSB Bren
    footnote: Corresponding Author
  - name: Masami Fujiwara
    email: fujiwara@tamu.edu
    affiliation: TAMU Wildlife
  - name: Jasmin Diaz-Lopez
    email: jasmindiazlopez@tamu.edu
    affiliation: TAMU Wildlife
address:
  - code: UCSB Bren
    address: Bren School of Environmental Science & Management, University of California Santa Barbara, Santa Barbara, CA 93106-5131, USA
  - code: TAMU Wildlife
    address: Department of Wildlife and Fisheries Sciences, Texas A&M University, College Station, TX 77843-2258, USA
abstract: |
  Matrix population models (MPMs) are powerful tools for translating demographic and life history information into a form that can be used to address a wide range of research topics, such as projecting population dynamics, evaluating stressor impacts on populations, and studying life history evolution. However, the reliability of such studies depends on the MPM being constructed in a way that accurately reflects the species’ life history. We highlight three errors commonly encountered in published MPMs: (1) failing to include survival as well as fertility in the reproduction term; (2) introducing a one-year delay in age at first reproduction; and (3) incorrectly calculating the growth transition rate out of a stage with a mean development time greater than the model time step. We review the sources of such errors and provide new analyses revealing the impact of such errors on model predictions. These MPM construction issues are treated extensively in textbooks, so their existence in current literature is surprising. To quantify the prevalence of such errors we examined and scored the original publications underlying the models in the COMADRE Animal Matrix Database. The first two errors were found in 41% and 42%, respectively, of the published studies; all were in models that used a “post-breeding census” representation of the life cycle graph (in which newborns [eggs, neonates, fledglings, etc.] are explicitly included). Of the studies where stages may last longer than one time step, 25% constructed the growth rate using inappropriate formulas, and 37% used methods that were either undescribed or would generate the correct development time only if the population remained at the observed within-stage age structure. These results suggest that further efforts may be required to educate biologists on the construction of MPMs, perhaps in concert with the development of new software tools. Furthermore, the conclusions of many studies that are based on MPMs may need to be re-examined, and synthetic studies using the COMADRE Database need to be undertaken with caution.

keywords: COMADRE animal matrix database, Lefkovitch matrix, Leslie matrix, Matrix population models
bibliography: Bibliography.bib
csl: ecological-modelling.csl
output: 
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
    keep_tex: true
    fig_caption: true
numbersections: true
layout: "12pt, 1p"
linenumbers: true
tables: true
journal: "Ecological Modelling"
---

```{r knitr_options, echo=FALSE, message=FALSE}
show_code <- FALSE
knitr::opts_chunk$set(echo = show_code, message = show_code, warning = show_code,
                      comment = NA)
```

# Introduction 
The use of matrix population models (MPMs) for the ecological study of plants and animals has expanded rapidly in recent years [@Salguero-Gomez2015; @Salguero-Gomez2016].
MPMs are a convenient way to synthesize demographic information about a population, and are useful in addressing ecological, evolutionary, and management questions [@Caswell2001; @Morris2002a].
Most early MPMs were developed by collaborations between biologists with expertise on the species at hand and modelers with deep understanding of the subtleties of modeling.
MPMs now, having been long promoted as a straightforward translation of life-history information into quantitative analysis, are often being created by biologists who are primarily empirical ecologists or conservation biologists, and may have had little training in modeling beyond a graduate course in population ecology.
One might then ask, do these MPMs reliably reproduce the life histories they are meant to represent? 

It is important to remember that MPMs are approximations, both because they still abstract away much biological detail and because demographic measurements are imprecise. 
There are a variety of subtleties in constructing such models, especially when breeding is spread across a substantial fraction of the year or when there is substantial heterogeneity among individuals within an age or stage class; much theoretical work has gone into making MPMs more complex to account for this, and we are starting to better understand the effects of these phenomena on simple models [e.g., @Fujiwara2017]. 
But even setting aside these issues, we might hope that, if we assume that a simple life history description (e.g., as embodied in an age- or stage-structured life table) is a useful description of the population, then the constructed MPM should accurately reproduce that description. 
If it does not, then we are introducing additional errors into the analysis above and beyond the inherent approximations of modeling.

One of us (BEK) has spent two decades teaching MPMs to applied masters students. 
This experience has revealed several aspects of MPM construction that are particularly challenging to novices, and thus might be similarly challenging to biologists who do not regularly create mathematical models of their system. 
Furthermore, the students, when sent to find a published model to analyze, have uncovered a suprising number of published MPMs that have failed to meet these challenges. 
At one level, the errors made by these novices are "simply" accounting issues, but our interpretation is that the difficulty that students have in overcoming them is rooted in the contrast between the often-loose way that terms are used to describe biological populations and the very precise meanings of terms in MPMs (together with some genuine linguistic ambiguity that plagues the field).

Our goal in this paper is to highlight these challenges (which are described in the next section), quantify their impacts on the outputs of MPMs, and document their prevalence in the peer-reviewed literature. 
We conclude with a discussion of why these MPM construction errors are so prevalent, and how we might improve future practice.

# Challenges in MPM construction
Matrix population models operate in discrete time, and as such are most naturally suited to species whose reproduction is concentrated in a short breeding season [so-called "birth-pulse" populations; @Caswell2001 *[did Caswell coin this phrase?]*]. 
Many animals and plants satisify this assumption, and we will focus on this case in our analysis. However, much of the theoretical development of MPMs was motivated by human demography, in which reproduction occurs throughout the year ("birth-flow" populations). 
This requires a variety of mathematical approximations to suitably transform continuous-time processes into a discrete-time representation, and gives a different view of the identity of individuals in a particular age or stage class. 
We will not treat the former here, but the latter is relevant. 

MPMs assume that the population at time $t$ is a snapshot at a particular "census date." 
The discretization of age into classes means that in a birth-flow population, the first age class represents all individuals between zero and one timestep old at time $t$, and thus we would describe it as "Age 0--1." 
In contrast, in a birth-pulse population, all individuals in an age class are (more-or-less) exactly the same age. 
If the census were taken immediately after the breeding season^[Defined as the season in which individuals are born, not the season during which their parents mate.] (a "post-breeding census"), the first age class would comprise newborn individuals, all of age zero, the second class would comprise individuals of age exactly one, etc.^[In principle, the census could occur at any time relative to the breeding season, and @Caswell2001 provides general formulas to account for this; but in practice the two cases described here encompass nearly all, if not all, published birth-pulse models.] 
In contrast, if the census were taken immediately before the breeding season (a "pre-breeding census"), the youngest age class would be made up of individuals all with age exactly one. 
But we often see birth-pulse models in which the age classes are given as a range---this is incorrect, and leads to ambiguity (does the class "Age 0--1" refer to newborns or to one-year-olds?) that can confuse the practitioner on how best to construct the model. 
This nomenclature problem likely has two sources. First, many texts introduce birth-flow models first [e.g., the very first figure in @Caswell2001, illustrating the notion of discrete age classes, shows the classes as ages 0--1, 1--2, etc.]. Second, in colloquial use, age-associated terms often span an age range: for example, in ungulates the term "yearling" refers to any individual between the ages of one and two. 
When that same term is applied to a class in a birth-pulse MPM, nontrivial cognitive effort is required to mentally redefine it (so that "Yearling" means age exactly one). 

This nomenclatural ambiguity plays a role in all three of the "accounting errors" that follow.
An additional challenge is that most textbooks use inconsistent notation and subscripting conventions for age- and stage-structured models.
Age-structured models follow a convention that makes sense for a continuously breeding species: an individual is assigned to an age class that is numbered with the individual's age at its *next* birthday (but note that this differs from colloquial use in most languages, where we identify a person's age with their *previous* birthday).
When looking at a species with discrete breeding seasons, this convention is perfectly fine for a pre-breeding census model, as all individuals are just a tiny fraction of a timestep away from their next birthday, and an individual that is almost three years old will have characteristics almost indistinguishable from one that is exactly three years old.
In contrast, for a post-breeding census model, this convention would identify an individual that is just a tiny bit past its third birthday as a four-year-old.
This means that "$x$-year-old survival" (often denoted $P_x$) refers to survival from age $x$ to age $x+1$ in a pre-breeding census model, but from age $x-1$ to age $x$ in a post-breeding census model.

This is potentially confusing, but most practitioners don't move between these models so it is probably not a large issue.
However, transitioning from an age-structured model (which is what all texbooks use for a detailed explanation of MPMs) to a stage-structured model creates huge problems, at least for post-breeding census models.
This is because, whereas an individual that was $x$ years old at its recent birthday will be exactly $x+1$ years old at its next birthday, and can be unambiguously identified as "age class $x+1$," an individual that was in stage $x$ at its recent birthday might be in any of a number of stages at its next birthday, preventing the application of the age-structure convention.
The solution is for post-breeding census stage structured models to assign individuals to the stage class they were in at their recent birthday.
This is perfectly sensible, but *most textbooks make this transition without comment.* [CHECK WHAT MILLS DOES HERE]
Thus it is not obvious to a novice that the carefully-explained conventions of age-structured models no longer apply; we suspect that this contributes to some of the common errors described below.

To avoid the need to be pedantic when moving between age- and stage-structured models, we will apply the stage-structured convention to age-structured models.
Thus, in a post-breeding census, individuals that have just been born are classified as "age zero" or "newborn," with a subscript of zero.
This will make our exposition clearer, but it is important to note that our lifetables and age-structured models will therefor look different from most textbooks.

## Ensuring that the fertility transition spans a full timestep
In a life table (e.g., Table \ref{tab:lifetable}, age specific survival and birth rates look functionally equivalent. 
But there is an important difference: survival (often denoted $P_x$ (most common, but has a different meaning in stage-structured models), $s_x$, or $\sigma_x$, where $x$ is the age or stage; we will use $\sigma_x$) represents the fraction of individuals in class $x$ that survive for a full timestep, from time $t$ to time $t+1$. 
In contrast, the birth rate (typically denoted $b_x$ or $m_x$; we use the former) is instantaneous: it is the number of of offspring produced at time $t$ by an individual that is alive at time $t$. 
It is tempting to draw a life-cycle diagram like the one in Fig. \@ref(fig:lifecycles)a (and we commonly see that in the literature). 
While this works as a *conceptual* diagram, translating it directly into an MPM by coverting each arrow in the graph into a matrix element is incorrect: each transition in the matrix must span a timestep, and $m_x$ does not accomplish that. 
```{r lifetable, results='markup', echo=FALSE}
### Make and display a sample life table
sample_life_table <- data.frame(
  Age = c(0:4, "$\\vdots$"),
  Survival = c(0.2, 0.4, 0.4, 0.9, 0.9, "$\\vdots$"),
  Birth = c(0, 0, 0, 3, 3, "$\\vdots$"),
  Stage = c("Newborn", "Juvenile", "Juvenile", "Adult", "Adult",
            "$\\vdots$")
)

names(sample_life_table) <- c("Age in years ($x$)", 
                              "Annual survival ($\\sigma_x$)",
                              "Birth rate ($b_x$)",
                              "Stage")
knitr::kable(sample_life_table, escape = FALSE,
             booktabs = TRUE,  align = c("c", "c", "c", "c"),
             caption = "A sample life table for a species that
             reaches sexual maturity at age 3 (adult stage). 
             Adults continue to survive and
             reproduce indefinitely with the same survival 
             and birth rates.
             Note that, because we are using the 
             stage-structured convention for assigning age 
             class names (see text), the table may look slightly
             different from those in many textbooks.")
```

```{r lifecycles, echo=FALSE, warning=FALSE, message=FALSE, fig.cap='Four life-cycle diagrams that might (or might not) represent the life table in Table 1. (a) A "naive" representation that associates each arrow with a vital rate. This fails to account for the fact that the reproductive transitions must span a timestep and therefor include a survival term. (b) A pre-breeding census representation, in which the youngest censused class is Age 1 and the adult birth rate is multiplied by newborn survival. (c) A post-breeding census representation, in which the adult burth rate is correctly multiplied by adult survival, but which fails to account for the fact that Age 2 individuals will have reproduced (as adults) just prior to the next census. (d) A correct post-breeding census representation.'}
library(diagram)
class_names <- c("Age 0", "Age 1", "Age 2", "Adult")
op <- par(mfrow = c(2,2), mar = c(0.1, 0.1, 1.6, 0.1))

# Common control paramters for the diagrams
# Set them once here so that they can be easily updated
# Unfortunately plotmat() is not scale-independent!
pos = 4
self.shiftx = 0.15
self.shifty = -0.08
self.lwd = 2
self.lwd = 2
self.cex = 1
self.arrpos = NULL
shadow.size = 0.0
relsize = 0.89
mx = -0.05
arr.type = "triangle"
arr.length = 0.2

# "Naive" life cycle diagram
mat1 <- as.data.frame(
  matrix(nrow = 4, ncol = 4, byrow = TRUE, data = 0)
)
mat1[[2,1]] <- "sigma[0]"
mat1[[3,2]] <- "sigma[1]"
mat1[[4,3]] <- "sigma[2]"
mat1[[4,4]] <- "sigma[3]"
mat1[[1,4]] <- "b[3]"
curves <- matrix(0, 4, 4)
curves[2,1] <- curves[3,2] <- curves[4,3] <- 1
curves[1,4] <- 0.5
plotmat(mat1, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "\na) Naive representation (incorrect)")

# Pre-breeding census 
mat2 <- mat1[-1,-1]
mat2[[1,3]] <- "b[3] * sigma[0]"
curves2 <- curves[-1,-1]
curves2[1,3] <- 0.5

plotmat(mat2, name = class_names[-1], pos = 3, curve = curves2, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "\nb) Pre-breeding census representation (correct)")

# Incorrect post-breeding census
mat3 <- mat1
mat3[[1,4]] <- "sigma[3] * b[3]"
plotmat(mat3, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "c) Post-breeding census representation \n(incorrect)")

# Correct post-breeding census
mat4 <- mat3
mat4[[1,3]] <- "sigma[2] * b[3]"
curves[1,3] <- curves[1,4]
plotmat(mat4, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "d) Post-breeding census representation \n(correct)")

par(op)
```

To get the timestep in there, we need to multiply $b_x$ by somebody's survival---either the parent or the offspring. 
For a pre-breeding census model, the reproductive transition is $F_x = b_x \sigma_0$: the parent, in class $x$, produces $b_x$ offspring immediately after the census, and then these offspring survive to the end of the timestep at rate $\sigma_0$ (Fig. \@ref(fig:lifecycles)b). 
For an annual timestep, the transition $F_x$ represents the number of one-year-olds next year produced by an individual in class $x$ this year. 

In a post-breeding census, the parent (which will have just reproduced if it is already an adult) must survive for a timestep, aging by a timestep and possibly maturing into a new class, and then reproduces with a birth rate appropriate to its class at the end of the timestep. 
If we use $x'$ to denote the parent's class at time $t+1$, then the transision is $F_x = \sigma_x b_{x'}$ (Fig. \@ref(fig:lifecycles)d). For an annual timestep, $F_x$ is the number of zero-year-olds (newborns) next year produced next year by an individual that was in class $x$ this year. 
Properly accounting for $x'$ is a separate challenge that we address in the next subsection.


## Matching the age at first reproduction to the species' life history
In an age-structured population, the lowest age with a non-zero birth rate represents the age at first reproduction; let us call that $x_m$, for "age at [reproductive] maturity." 
In a post-breeding census model, the individuals who are age $x_m$ at the end of the timestep, and have just reproduced for the first time, were age $x_m - 1$ at the beginning of the timestep. 
This creates a reproductive transition from age class $x_m - 1$ to age class zero---the lower of the two reproductive transitions in Fig. \@ref(fig:lifecycles)d. 
Embracing this transition requires overcoming cognitive dissonance---"juveniles" are reproducing!---and failure to do so results in models like that in Fig. \@ref(fig:lifecycles)c.
Pre-breeding census models do not cause this problem, as the newly matured, about-to-reproduce-for-the-first-time individuals are already classified as age $x_m$, matching intuition.

This is also not a challenge for post-breeding census models if we follow the convention of associating the age class with the age at the individual's next birthday.
Then the reproduction by newly maturing individuals is $F_{x_m} = \hat{\sigma}_{x_m} b_{x_m}$ (we use $\hat{\sigma}$ for survival to clarify that it is a differently indexed parameter from $\sigma$ as used above); the cognitive dissonance is finessed by "hiding" the fact that these individuals started the timestep as juveniles.
Indeed, this is a strong justification for the convention.
However, this convention cannot be maintained when moving from age-structured to stage-structured models; since most animal MPMs are at least partially stage structured, we suspect that textbooks' failure to force a confrontation with this cognitive dissonance in the conceptually simpler age-structured models leaves practitioners unprepared to face it (or even recognize its necessity) in stage-structured models.

The simplest stage-structured model has newborns, a nonreproductive juvenile class that spans multiple timesteps, and reproductive adults (Fig. \@ref(fig:SScycles)).
Within the juvenile class, some individuals remain juveniles in the next timestep (should they survive), whereas others mature into adults.
If $\gamma_j$ is the fraction surviving individuals that mature ("grow") at the end of the timestep, then the Juvenile--Juvenile transition is given by $P_j = \sigma_j (1-\gamma_j)$ and the Juvenile--Adult transition is given by $G_j = \sigma_j \gamma_j$. 
This is true for both pre-breeding and post-breeding census models.
However, for the latter, the individuals that made the Juvenile--Adult transition were already adults at the just-passed breeding season, and hence have had their first opportunity to reproduce.
Thus we need a reproductive transition leading out of the juvenile class---$F_j = G_j b_a$---which again seems to defy common sense.
There is no way to finesse this in the way that has been done in age-structured models: if we classify individuals by their stage at their next birthday, so that the maturing individuals are called "adults," then we impose a constraint that individuals in the last year of the juvenile stage have the same survival as adults, which often isn't accurate.
There are further obstacles to any attempted finesse in more complicated models in which individuals can "mature" into more than one subsequent class.

```{r SScycles, echo=FALSE, warning=FALSE, message=FALSE, fig.cap='Four life-cycle diagrams that might (or might not) represent stage structured life table in Table 1. (a) A "naive" representation that associates each arrow with a vital rate. This fails to account for the fact that the reproductive transitions must span a timestep and therefor include a survival term. (b) A pre-breeding census representation, in which the youngest censused class is the juvenile stage and the adult birth rate is multiplied by newborn survival. (c) A post-breeding census representation, in which the adult burth rate is correctly multiplied by adult survival, but which fails to account for the fact that the maturing juveniles will have reproduced (as adults) just prior to the next census. (d) A correct post-breeding census representation.'}
library(diagram)
class_names <- c("Newborn", "Juvenile", "Adult")
op <- par(mfrow = c(2,2), mar = c(0.1, 0.1, 1.6, 0.1))

# Common control paramters for the diagrams
# Set them once here so that they can be easily updated
# Unfortunately plotmat() is not scale-independent!
pos = 3
self.shiftx = 0.
self.shifty = -0.15
self.lwd = 2
self.lwd = 2
self.cex = 1
self.arrpos = -1.6
shadow.size = 0.0
relsize = 1
mx = 0
arr.type = "triangle"
arr.length = 0.3

# "Naive" life cycle diagram
mat1 <- as.data.frame(
  matrix(nrow = 3, ncol = 3, byrow = TRUE, data = 0)
)
mat1[[2,1]] <- "sigma[n]"
mat1[[2,2]] <- "P[j]"
mat1[[3,2]] <- "G[j]"
mat1[[3,3]] <- "sigma[a]"
mat1[[1,3]] <- "b[a]"
curves <- matrix(0, 3, 3)
curves[2,1] <- curves[3,2] <- 0.1
curves[1,3] <- 0.5
plotmat(mat1, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "\na) Naive representation (incorrect)")

# Pre-breeding census 
mat2 <- mat1[-1,-1]
mat2[[1,2]] <- "b[a] * sigma[n]"
curves2 <- curves[-1,-1]
curves2[1,2] <- 0.5

plotmat(mat2, name = class_names[-1], pos = pos-1, curve = curves2, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "\nb) Pre-breeding census representation (correct)")

# Incorrect post-breeding census
mat3 <- mat1
mat3[[1,3]] <- "sigma[a] * b[a]"
plotmat(mat3, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "c) Post-breeding census representation \n(incorrect)")

# Correct post-breeding census
mat4 <- mat3
mat4[[1,2]] <- "G[j] * b[a]"
curves[1,2] <- curves[1,3]
plotmat(mat4, name = class_names, pos = pos, curve = curves, 
        self.shiftx = self.shiftx, self.shifty = self.shifty, 
        self.lwd = self.lwd, self.cex = self.cex, 
        self.arrpos = self.arrpos, shadow.size = shadow.size, 
        relsize = relsize, mx = mx, arr.type = arr.type,  
        arr.length = arr.length,
        main = "d) Post-breeding census representation \n(correct)")

par(op)
```

In both stage- and age-structured models, failing to have the reproductive transition out of the last juvenile class in post-breeding census models will lead to a one-year delay in the age at first breeding, relative to the life history that the model is meant to represent.

## Ensuring that the mean time in each developmental stage matches the species' life history
The final challenge is associated with estimating $\gamma_x$, the fraction of individuals maturing out of stage $x$.
With longitudinal data on individuals, one can simply derive this from the observations, for example using multistate CMR models (CITE, although this is not guaranteed to be robust; see Discussion).
However, in many cases, the goal is to combine information on stage-specific survival, often variously collected, with knowledge about the stage duration (the number of timesteps that individuals remain in a stage before maturing).
If stage durations are fixed (e.g., all individuals mature after two years as juveniles), then the goal is to create a "stage-for-age" model (e.g., Ebert) where the mean stage duration in the model equals the fixed stage duration in the life history.
Even where real stage durations are somewhat variable, if there is a well-defined mean stage duration, then we can still apire to have the modeled mean stage duration match the actual mean stage distribution.


@Caswell2001 has a section of his book describing various ways of doing this.
It's not clear that there is a single "best" approach, as the stage-structured model will never match the age-structured model in all ways (see Discussion).
Nevertheless, the primary analyses performed on most published MPMs are to calculate the asymtotic growth rate ($\lambda$) and the sensitivity of $\lambda$ to underlying demographic parameters. 
For these calculations, there is one (and only one) recipe to create a stage structured model that will generate the same results as the equivalent age-structured model with fixed stage durations.
As best we can tell, it was first introduced by @Caswell1989, although its first application to an ecological populaton may have been by @Crowder1994; it is covered in Caswell's (2001) section on stage-structured models. 

The basic idea is that $\gamma$ represents the fraction of individuals in the stage that have spent enough time in the stage to mature. 
This, in turn, depends on the (virtual) age structure within the stage.
In general, this age structure could have any form, depending on the recent history of the population; the one time it is well defined is when the population is at the stable age/stage distribution.
This is exactly the condition for calculating $\lambda$.
Under these conditions, there are two factors that affect the age distribution within the stage, and hence the fraction of individuals of an appropriate age to mature.
The first is the stage-specific survival, which determines how a cohort shrinks as it ages.
The second is the population growth rate, which determines the degree to which one year's entering cohort is larger or smaller than the previous one.
This makes $\gamma$ non-trivial to calculate, as the resulting formula involves $\lambda$, which can only be calculated once the MPM has been constructed!
The solution is an iterative approach: take an initial guess of $\lambda$, calculate $\gamma$ from the formula; calculate the dominant eigenvalue of the resulting matrix; use that as a new guess for $\lambda$; and repeat until the value of $\lambda$ stops changing.
For someone used to programming, this is straighforward to implement; but non-modellers find this daunting, and we do not know of any programs that implement this algorithm, aside from some difficult-to-generalize Matlab code in @Morris2002a. **Check this out**
We will refer to this as the "asymptotic age structure" (AAS) model.

Thus, non-modellers will be tempted by easier-to-calculate formulas. 
Some discover a predecessor to the above formula [@Crouse1987] that had been developed for the same population studied by @Crowder1994.
This formula is complex-looking but straighforward to calculate, as it doesn't require iteration (in incorporates the within-cohort dynamics, but *assumes* that $\lambda = 1$).
We will refer to this as the "stationary age structure" (SAS) model (where "stationary" means that the population is neither growing nor declining).

An even simpler approach is to simply say that, if the stage duration is $T$ timesteps, then the fraction maturing is $1/T$. 
This effectively assumes that the age distribution is perfectly flat.
Its popularity probably stems not just from the fact that it is simple to calculate and explain, but because it is the first solution to the problem listed by @Caswell2001, who seems to endorse it. **Check Caswell's actual wording**
We will refer to this as the "flat age structure" (FAS) model.

As mentioned above, only the AAS model will replicate $\lambda$ and its sensitivities from the fully age-structured model.

# Consequences of incorrect MPM construction
We evaluate the impacts of these errors in MPM construction by examining several endpoints that many analyses focus on: the asymptotic population growth rate ($\lambda$), sensitivity analysis of $\lambda$ to changes in underlying vital rates, and life history statistics such as generation time. 
We approach this evaluation through theoretical analysis (where feasible and informative) and by examining two case studies: a lionfish (*Pterois* sp.) model with very high population growth [@Morris2011], and a pair of American alligator (*Alligator mississippiensis*) models that project rapdily declining and nearly constant population dynamics, respectively [@Dunham2014]. 
These studies made all three of the errors described above; we singled them out not because they are particularly egregious (many other studies make these errors) but because they do an exceptional job of describing the species' life history, allowing us to infer the model they meant to construct.
All three of these models had other minor errors, which we corrected (while retaining the three focal errors) to create "baseline" models. 
We then constructed models that fixed one, two, or three of the focal errors to see how these errors affect the model projections and conclusions.

A matrix population model for lionfish was constructed by Morris et al. (2011) to investigate the potential approaches for controlling the invasive species. The model consist of three stages (larvae, juvenile, and adult), and time step of the model is one month. The original model was a post-breeding census model, but it did not include the survival of adults in the fertility rate. The average duration of the juvenile stage was assumed to be 12 months in the model. This meant they take 14 months for the first reproduction (one month in larvae stage, 12 months in juvenile stage, and one additional month in fertility rate) even though they start reproducing in 12 months. The authors used FAS model for calculating the transition rates for juveniles. We developed four stage-structured population models that gradually correct for some or all of these problems and one Leslie matrix (Table \@ref(tab:ModelList)). Along with the original models, we used the six models to calculate $\lambda$, stable stage distribution, reproductive value, sensitivity and elasticity of $\lambda$ to stage-specific survival rate and fecundity, damping ratio, and generation time (Appendix 1). 

For American alligator populations, Dunham et al. 2014 developed two stage-structured matrix population models to compare the status of northern and southern populations. The original models consist of five stages (eggs, larvae, juvenile, subadults, and adults), and the time step of the model is one year. Similarly to the lionfish model, the alligator models are post-breeding census models, but the authors did not include the survival of adults in the fertility rate. The first stage was egg stage, but it only lasted for three months; therefore, there was clear inconsistency in the time steps among stages. Dunham et al. used AAS model to calculate transition rates for juvenile and subadult stages.  We developed two additional stage-structured models that corrects some or all of these problems and one Leslie matrix for each population (Table 1). The four population models for each population were used to calculate the same quantities that we calculated with the lionfish models (Appendix 1). 



Table: (\#tab:ModelList) List of models and description of changes made to the original models.

 ---------------------------------------------------------------------------------------------------------------------------------
  Population                      Model   Description
  ------------------------------- ------- -----------------------------------------------------------------------------------------
  Lionfish                        L1      -   Original three-stage model in Morris et al., 2011
                                          
                                          

                                  L2      -   Correction of juvenile duration
                                          
                                          -   Incorporation of adult survival in fertility rate
                                          
                                          

                                  L3      -   All of the corrections in L2
                                          
                                          -   Incorporation of fertility rate of juvenile stage
                                          
                                          

                                  L4      -   All of the corrections in L3
                                          
                                          -   Use of SAS model for calculating juvenile transition rate
                                          
                                          

                                  L5      -   All of the corrections in L3
                                          
                                          -   Use of AAS model for calculating juvenile transition rate
                                          
                                          

                                  L6      -   Leslie matrix
                                          
                                          

  American Alligator (Northern)   A1      -   Original five-stage model in Dunham et al. 2014
                                          
                                          

                                  A2      -   Reduction in the number of stage to four (hatchling, juvenile, subadult, and adult)
                                          
                                          -   Incorporation of survival rate into fertility rate of adult stage
                                          
                                          -   Addition of fertility rate to subadult stage
                                          
                                          

                                  A3      -   All of the corrections made in A2
                                          
                                          -   Calculation of juvenile transition rates using AAS model
                                          
                                          

                                  A4      -   Leslie matrix
                                          
                                          

  American Alligator (Southern)   A5      -   Original five-stage model in Dunham et al. 2014
                                          
                                          

                                  A6      -   Reduction in the number of stage to four (hatchling, juvenile, subadult, and adult)
                                          
                                          -   Incorporation of survival rate into fertility rate of adult stage
                                          
                                          -   Addition of fertility rate to subadult stage
                                          
                                          

                                  A7      -   All of the corrections made in A6
                                          
                                          -   Calculation of juvenile transition rates using AAS model
                                          
                                          

                                  A8      -   Leslie matrix
                                          
                                          
  ---------------------------------------------------------------------------------------------------------------------------------




## Effects on asymptotic population growth rate ($\lambda$) 
The original lionfish model (L1) had $\lambda$ of 1.125; this meant they grew by 12.5% each month (Figure S1). Even though they are invasive species and rapidly expanding. The population growth rate is unrealistically high. By reducing the average duration in juvenile stage (L2) and incorporating fertility rate on juvenile stage, the population growth rate increased further (L3). However, the use of SAS model to calculate the juvenile transition rate (L4) reduced $\lambda$ substantially. This is because for the duration of the juvenile stage (11 time steps on average), the survival rate is low. Incorporation of $\lambda$ in calculation of the transition rates (AAS models; L5) reduced $\lambda$ because $\lambda$>>1. This meant that there was an increase in number of individuals recruited into juvenile stage from larval stage; therefore, the actual age-distribution declines faster with age than the stable age distribution. The Leslie matrix (L6, which is expected to be least prone to the errors associated with the manipulations of parameters, and model L5 had the same $\lambda$.

The original alligator models had $\lambda$ of 0.87 for the northern population and 1.02 for the northern population (Figure S8). In contrast to lionfish example, $\lambda$ was affected very little with the corrections. Changes in the fertility rate had very little effect because $\lambda$ was not sensitive to fertility rate. Changes in the transition rates for juvenile and subadult stages had little effect because, for the short durations in the stages (7 years in each stage and 3 years in each stage for northern and southern populations, respectively), they had relatively high survival rates (0.78 and 0.73 for juvenile and subadult stages of both populations). 


## Effects on sensitivity analysis of $\lambda$
Similarly to the results on $\lambda$, sensitivity and elasticity of $\lambda$ to stage-specific survival and fecundity were affected more for lionfish than alligator. For lionfish population, the rank order of both sensitivity and elasticity among stages changed from L3 to L4 as we changed the way we calculate the transition rates (Figures S4 & S5). This implies that conservation strategy can be affected by the errors in developing a population matrix. 

For lionfish models, changes in sensitivity and elasticity are less clear (Figures S11 & S12), but stable stage distribution (Figure S9) and reproductive values (Figure S10) are affected by the errors. These quantities are used for calculating sensitivity and elasticity of $\lambda$. For example, the original model substantially under-estimated the stable stage distribution and over-estimated the reproductive value of adults.

## Effects on life history statistics
Damping ratio is a measure of how long transient dynamics lasts in a system after a perturbation, and generation time is a measure of time scale of populations. These quantities are expected to be affected by converting the age-structured into stage-structured models.  

# Prevalence of construction errors in published MPMs
## Methods
To evaluate the prevalence of these errors in published MPMs, we examined a sample of the studies contaned in the COMADRE animal matrix model database [@Salguero-Gomez2016]. 
Using version 2.01 of the database, we subset the data to studies of nonhuman animals that had a DOI (as a simple filter to eliminate non-peer-reviewed studies). 
This left 65 studies published prior to the year 2000, and roughly twice that number published from 2000 to 2018. 
We retained all of the 20th century studies and took a random sample of 60 of the 21st century studies. 
Although many studies publish multiple models, representing different sites or species, we take the study as the unit of observation, as a similar approach was usually taken in all the models within a publication.

Using a haphazard subset of studies, we developed a protocol to systematically assess each study (Appendix 2). 
This protocol was applied by NNN members of the COMADRE digitization team ("Compadrinos"), all graduate students in demography at the Max Planck Institute for Demographic Research.
After initial training, consistency was ensured by having all members of the team, as well as the lead author of this paper, independently apply the protocol to the same set of papers until all were getting consistent results.
If a question didn't apply (e.g., if it was not a stage-structure model), the answer was coded "NA;" if the answer could not be determined from the information in the publication, it was coded as "unknown."

Questions related to fertility

Questions related to first reproduction

Questions related to maturation

Statistical analysis: means, trends through time

## Results
*Note: The data collection by the Compadrinos is ongoing. Here we report an analysis based on data collected for the initial feasibility study for the project. The publications are recent and haphazardly chosen, but for this preliminary review we have analyzed and presented these data in the same form that we plan for the final dataset.*

```{r get_data}
library(xlsx)
library(magrittr)
library(tidyverse)
data_file <- "Protocol_test_Kendall.xlsx"
mpm_data <- as.tibble(read.xlsx(data_file, 1))
```

```{r error_stats}
error_stats <- function(errmodel) {
  error.perc <- round(mean(errmodel$model[[1]]) * 100)
  error.n <- length(errmodel$model[[1]])
  error.P <- round(summary(errmodel)$coef[2,4], 3)
  error.trend <- if (error.P > 0.05) {
    "had no detectable trend"
  } else if (coef(errmodel)[2] > 0) {
    "increased"
  } else {
    "decreased"
  }
  return(list(perc = error.perc,
              n = error.n,
              P = error.P,
              trend = error.trend))
}
```

```{r rep_in_fec}
## Errors in fecundity term
mpm_data %<>% mutate(
  FecCorrect = (CensusType == "Pre" & SurvInRep == "Offspring") |
    (CensusType == "Post" & SurvInRep == "Parent")) 
mpm_data <- within(mpm_data, 
                 FecCorrect[SurvInRep %in% c("Unknown", "Not Applicable")] <- NA)
FecErrors.glm <- glm(!FecCorrect ~ YearPublication, data = mpm_data, 
                      family = "binomial")

FecErrors <- error_stats(FecErrors.glm)
FecErrors$post <- (sum(
    with(mpm_data, CensusType[!FecCorrect] == "Post"), na.rm = TRUE
  ) / sum(!mpm_data$FecCorrect, na.rm = TRUE)) * 100

```

```{r mat_age}
### Errors in age at maturity
mpm_data_post <- mpm_data %>% 
  filter(CensusType == "Post") %>%
  mutate(
    ReproWithMatLogical = as.logical(recode(ReproWithMaturation, 
                                          "Not Applicable" = "NA", 
                                          Unknown = "NA", 
                                          Yes = "TRUE", 
                                          No = "FALSE")) 
)

ReproWithMatErr.glm <- glm(!ReproWithMatLogical ~ YearPublication, 
                           data = mpm_data_post, family = "binomial")
ReproWithMatErrors <- error_stats(ReproWithMatErr.glm)
```

```{r stage_duration}
mpm_data_ls <- mpm_data %>%
  filter(!LongStages %in% c("0", "None")) %>%
  mutate(
    GrowthTransition = recode(GrowthTransition,
                              Cohort = "SAS",
                              "1/T" = "FAS",
                              "Caswell6.103" = "AAS")
  ) %>% droplevels()

mpm_data_ls2 <- mpm_data_ls %>%
  filter(GrowthTransition != "Unknown") %>% 
  mutate(GTcorrect = GrowthTransition %in% c("AAS", "Unrolled")) %>%
  droplevels()

MatDurErr.glm <- glm(!GTcorrect ~ YearPublication, 
                           data = mpm_data_ls2, family = "binomial")
MatDurErrors <- error_stats(MatDurErr.glm)

```
We were able to unambiguously identify the components of the fecundity term in `r FecErrors$n` studies.
`r FecErrors$perc`% of these studies failed to include an appropriate survival component in the reproduction terms; `r FecErrors$post`% of these errors were in post-breeding census models.
The frequency of these errors `r FecErrors$trend` over time ($P =$ `r FecErrors$P`; Fig. \@ref(fig:regplots)a).

The potential for missing the reproductive event associated with first reaching reproductive age is only a feature of post-breeding census models.
Of the `r ReproWithMatErrors$n` studies in which we could unambiguously determine both the last pre-reproductive stage or age class and in which we could identify reproductive transitions, `r ReproWithMatErrors$perc`% made this error.
The frequency of these errors `r ReproWithMatErrors$trend` over time ($P =$ `r ReproWithMatErrors$P`; Fig. \@ref(fig:regplots)b).

`r nrow(mpm_data_ls)` studies included models having at least one stage class that was meant to last for multiple timesteps; we were able to unambiguously classify the rule defining the maturation rate out of the stage(s) in `r MatDurErrors$n` of them.
Of these, `r MatDurErrors$perc`% did not use a rule that would generate a value of $\lambda$ that would match an age-structured model with the target mean stage duration (Fig. \@ref(fig:matdist)).
The frequency of these errors `r MatDurErrors$trend` over time ($P =$ `r MatDurErrors$P`; Fig. \@ref(fig:regplots)c).


```{r regplots, fig.asp=1, fig.cap='Trends in matrix population model construction errors through time. Trend line is logistic regression; vertical lines represent the data (jittered horizontally to prevent overlap). (a) Frequency of errors in reproduction term, among all studies. (b) Frequency of errors in timing of first reproduction, among studies with post-breeding census models. (c) Frequency of errors in mean stage duration, among studies with stage classes having mean stage durations > 1 timestep.'}
## Make plots
# Create a function for the plot
# Have x label only for last, y label only for middle
ts_plot <- function(dataset, aesthetic, xlabel = "", ylabel = "") {
  ggplot(dataset, aesthetic) + 
    geom_jitter(width = 0.05, height = 0, shape = "|", size = 2) +
    geom_smooth(method = "glm",  method.args = list(family = "binomial")) +
    theme_classic() + xlim(2010.95, 2015.05) + xlab(xlabel) +
    ylab(ylabel)
}
p1 <- ts_plot(mpm_data, aes(YearPublication, as.numeric(!FecCorrect)))
p2 <- ts_plot(mpm_data_post, aes(YearPublication, as.numeric(!ReproWithMatLogical)),
              ylabel = "Frequency of MPM construction errors")
p3 <- ts_plot(mpm_data_ls2, aes(YearPublication, as.numeric(!GTcorrect)),
              xlabel = "Publication Year")


library(ggpubr)
ggarrange(p1, p2, p3, ncol = 1, nrow = 3, labels = "auto", label.x = 0.95)
```

```{r matdist, fig.cap="Frequency of approaches for setting maturation rates from stages with mean duration exceeding one timestep."}
ggplot(mpm_data_ls2, aes(GrowthTransition)) + 
  geom_bar(aes(group=factor(0), y = ..prop..)) +
  theme_classic() +
  xlab("Maturation rule") + ylab("Frequency")
```

# Discussion
*[This outline will be fleshed out in the final version!]*

A.  Summary of impacts
B.  Summary of prevalence
C.  Why does this happen? Most texts are imcomplete (especially for stage-structured models) and/or have incosistent or confusing notation. Talk about @Caswell2001 as example. Also, these are "threshold concepts."
D.  Recommendations for practitioners:  
    1. Use prebreeding census whenever possible
    2. Unroll developmental stages (address sensitivity analysis challenges raised by Fujiwara and Diaz-Lopez, p. 2: "The inclusion of a large number of age-classes for long-lived organisms can make the interpretation of the sensitivity and elasticity analyses complicated because individuals in multiple age classes are often practically identical but separated in an age-structured model. Consequently, when long-lived organisms are studied, it is common to convert age-specific vital rates into stage-specific vital rates, and to use stage-structured population matrices for calculating $\lambda$ and generation time.")
E.  Recommendations for experts:
    1. Develop handbooks and training materials that are both comprehensive and clear to novices (reference threhshold concepts)
    2. Develop software tools to help guide practitioners through the process of translating demographic information in to MPMs

F.  Revisiting prior results
    1. Inidividual studies
    2. Syntheses

## Misc discussion items
- Paragraph about how AAS, SAS, and FAS models are related to each other [MF].

# Acknowledgments {.unnumbered}
This work was supported by [funding support to the compadrinos], a UCSB Faculty Senate grant to BEK, and [funding support to Masami & Jasmin]. We thank Rob Salguero-Gómez for feedback on the model evaluation protocol, and [list of compadrinos who actually worked on the project] for carrying out the model evaluations.

# References {#references .unnumbered}

